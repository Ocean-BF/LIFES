
<div class="tab-buttons">
  <button onclick="showTab('form')">入力フォーム</button>
  <button onclick="showTab('list')">履歴一覧</button>
</div>

<div id="form-tab">
  <form id="unit-form">
    <div class="form-group">
      <label>商品名</label>
      <input type="text" name="item_name" id="item_name" required list="itemList">
      <datalist id="itemList"></datalist>
    </div>

    <div class="form-group">
      <label>カテゴリ</label>
      <input type="text" name="category" id="category" required list="categoryList">
      <datalist id="categoryList"></datalist>
    </div>

    <div class="form-group">
      <label>価格（合計）</label>
      <input type="number" name="price" id="price" step="0.01" required>
    </div>

    <div class="form-group">
      <label>数量</label>
      <input type="number" name="quantity" id="quantity" value="1" min="1" required>
    </div>

    <div class="form-group">
      <label>内容量</label>
      <input type="number" name="amount" id="amount" step="0.01" value="1" required>
    </div>

    <div class="form-group">
      <label>店名</label>
      <input type="text" name="shop_name" id="shop_name">
    </div>

    <div class="form-group">
      <label>単価（自動計算）</label>
      <input type="text" id="unit_price" disabled>
    </div>

    <div class="form-group">
      <button type="submit">登録する</button>
    </div>
  </form>
  <div id="status"></div>
</div>

<div id="list-tab" style="display:none;">
  <div id="history"></div>
</div>

<style>
  .tab-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .tab-buttons button {
    padding: 10px 16px;
    font-size: 14px;
    border: none;
    border-radius: 8px;
    background-color: #ccc;
    cursor: pointer;
  }

  .tab-buttons button:hover {
    background-color: #aaa;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 14px;
    max-width: 480px;
    margin: auto;
    font-size: 16px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    margin-bottom: 4px;
    font-weight: bold;
  }

  input {
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }

  button[type="submit"] {
    padding: 12px;
    font-size: 16px;
    background-color: #007aff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  #history {
    max-width: 480px;
    margin: auto;
  }

  .record {
    background: white;
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }

  .record span {
    display: block;
    margin: 2px 0;
  }

  .record button {
    margin-top: 6px;
    background-color: #ff5e57;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
  }
</style>

<script>
async function showTab(name) {
  document.getElementById("form-tab").style.display = name === 'form' ? "block" : "none";
  document.getElementById("list-tab").style.display = name === 'list' ? "block" : "none";
  if (name === "list") {
    loadHistory();
  }
}

(async () => {
  const form = document.getElementById("unit-form");
  const price = document.getElementById("price");
  const quantity = document.getElementById("quantity");
  const amount = document.getElementById("amount");
  const unit_price = document.getElementById("unit_price");
  const statusEl = document.getElementById("status");
  const history = document.getElementById("history");

  function updateUnitPrice() {
    const p = parseFloat(price.value);
    const q = parseFloat(quantity.value);
    const a = parseFloat(amount.value);
    if (p && q > 0 && a > 0) {
      unit_price.value = (p / q / a).toFixed(4);
    } else {
      unit_price.value = "";
    }
  }

  [price, quantity, amount].forEach(input => {
    input.addEventListener("input", updateUnitPrice);
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const item_name = form.item_name.value.trim();
    const category = form.category.value.trim();
    const shop_name = form.shop_name.value.trim();
    const priceVal = parseFloat(price.value);
    const quantityVal = parseInt(quantity.value);
    const amountVal = parseFloat(amount.value);
    const unitPriceVal = parseFloat(unit_price.value);
    const uid = (await window.supabaseClient.auth.getUser()).data.user.id;

    const { error } = await window.supabaseClient.from("unit_prices").insert([{
      item_name, category, shop_name,
      price: priceVal, quantity: quantityVal,
      amount: amountVal, unit_price: unitPriceVal,
      user_id: uid
    }]);

    if (error) {
      statusEl.textContent = "登録に失敗しました。";
    } else {
      statusEl.textContent = "登録しました！";
      form.reset();
      unit_price.value = "";
    }
  });

  window.loadHistory = async () => {
    const uid = (await window.supabaseClient.auth.getUser()).data.user.id;
    const { data, error } = await window.supabaseClient
      .from("unit_prices")
      .select("*")
      .eq("user_id", uid)
      .order("created_at", { ascending: false });

    if (error) {
      history.innerHTML = "<p>履歴の取得に失敗しました。</p>";
      return;
    }

    history.innerHTML = data.map(row => `
      <div class="record">
        <span><strong>${row.item_name}</strong>（${row.category}）</span>
        <span>${row.quantity}個 × ${row.amount} = ￥${row.price}</span>
        <span>単価: ￥${row.unit_price} / 単位</span>
        <span>店名: ${row.shop_name}</span>
        <span>${new Date(row.created_at).toLocaleString()}</span>
        <button onclick="deleteRow(${row.id})">削除</button>
      </div>
    `).join("");
  };

  window.deleteRow = async (id) => {
    if (!confirm("この記録を削除しますか？")) return;
    const { error } = await window.supabaseClient.from("unit_prices").delete().eq("id", id);
    if (!error) loadHistory();
  };
})();
</script>
