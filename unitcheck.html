<!-- unitcheck-v8: 自由入力＋候補選択＋編集削除対応・表スクロール制御・表幅統一 -->
<div class="tab-buttons">
  <button id="formTab" class="tab-button active">入力フォーム</button>
  <button id="historyTab" class="tab-button">履歴一覧</button>
</div>

<div id="formSection" class="section">
  <form id="unitForm">
    <div class="row">
      <label for="item_name">商品名</label>
      <input list="item_list" id="item_name" name="item_name" required>
      <button type="button" onclick="showSelect('item_name', 'item_list')">▼</button>
      <datalist id="item_list"></datalist>
    </div>
    <div class="row">
      <label for="category">カテゴリ</label>
      <input list="category_list" id="category" name="category">
      <button type="button" onclick="showSelect('category', 'category_list')">▼</button>
      <datalist id="category_list"></datalist>
    </div>
    <div class="row">
      <label for="price">価格</label>
      <input id="price" required>
    </div>
    <div class="row">
      <label for="quantity">数量</label>
      <input id="quantity" value="1" required>
    </div>
    <div class="row">
      <label for="volume">内容量</label>
      <input id="volume" value="1" required>
    </div>
    <div class="row">
      <label for="shop_name">店名</label>
      <input list="shop_list" id="shop_name" name="shop_name">
      <button type="button" onclick="showSelect('shop_name', 'shop_list')">▼</button>
      <datalist id="shop_list"></datalist>
    </div>
    <div class="row">
      <label>単価</label>
      <div id="unitPriceDisplay" class="unit-price">-- 円</div>
    </div>
    <div class="row buttons">
      <button type="button" id="taxIn">税込価格にする</button>
      <button type="button" id="taxOut">税抜価格にする</button>
    </div>
    <div class="row"><button type="submit" id="submitButton">登録する</button></div>
    <div id="status" class="status"></div>
  </form>
</div>

<div id="historySection" class="section" style="display:none;">
  <div class="row filter-row">
    <label>商品名</label>
    <select id="filterItem"><option value="">すべて</option></select>
    <label>カテゴリ</label>
    <select id="filterCategory"><option value="">すべて</option></select>
  </div>
  <div id="historyListWrapper">
    <div id="historyList">履歴を読み込み中...</div>
  </div>
</div>

<script>
function showSelect(inputId, datalistId) {
  const input = document.getElementById(inputId);
  const datalist = document.getElementById(datalistId);
  const values = Array.from(datalist.options).map(o => o.value);
  const sel = document.createElement("select");
  sel.innerHTML = values.map(v => `<option value="${v}">${v}</option>`).join("");
  sel.onchange = () => input.value = sel.value;
  input.parentNode.insertBefore(sel, input.nextSibling);
  setTimeout(() => sel.focus(), 10);
}

function createEditableRow(row, data) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input value="${data.category || ""}"></td>
    <td><input value="${data.shop_name || ""}"></td>
    <td><input value="${data.unit_price?.toFixed(1) || ""}"></td>
    <td>${data.created_at?.split("T")[0]}</td>
    <td>
      <button onclick="saveRow(this, '${data.id}')">保存</button>
      <button onclick="loadHistory()">キャンセル</button>
    </td>`;
  row.parentNode.replaceChild(tr, row);
}

async function saveRow(btn, id) {
  const tr = btn.closest("tr");
  const inputs = tr.querySelectorAll("input");
  const [category, shop_name, unit_price] = Array.from(inputs).map(i => i.value);
  const supabase = window.supabaseClient;
  await supabase.from("unit_prices").update({
    category, shop_name, unit_price: parseFloat(unit_price)
  }).eq("id", id);
  loadHistory();
}

async function deleteRow(id) {
  if (!confirm("このレコードを削除しますか？")) return;
  const supabase = window.supabaseClient;
  await supabase.from("unit_prices").delete().eq("id", id);
  loadHistory();
}
</script>
