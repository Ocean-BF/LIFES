<div id="admin-link" style="display: none; margin-bottom: 20px; text-align: center;">
  <a href="admin.html" style="color: #4caf50; text-decoration: underline; font-weight: bold;">管理パネルへ</a>
</div>

<script>
(async function () {
  const client = window.supabaseClient;

  // セッション確認＆再接続
  const { data: sessionData } = await client.auth.getSession();
  if (!sessionData.session) {
    const { data: refreshed, error: refreshError } = await client.auth.refreshSession();
    if (refreshError || !refreshed.session) {
      alert("セッションが切れています。ログインし直してください。");
      location.href = "index.html";
      return;
    }
  }

  // ユーザー情報取得 + 管理者チェック
  const { data: { user } } = await client.auth.getUser();
  document.getElementById("user-email").textContent = user?.email || "取得できませんでした";

  const { data: adminData } = await client.from("profiles").select("is_admin").eq("id", user.id).single();
  if (adminData?.is_admin === true) {
    document.getElementById("admin-link").style.display = "block";
  }

  const bgColorInput = document.getElementById("bg-color");
  bgColorInput.oninput = () => {
    document.documentElement.style.setProperty("--bg-color", bgColorInput.value);
    localStorage.setItem("lifes_bg_color", bgColorInput.value);
  };

  const bgFileInput = document.getElementById("bg-file");
  bgFileInput.onchange = () => {
    const file = bgFileInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const url = e.target.result;
      document.body.style.backgroundImage = `url('${url}')`;
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundRepeat = "no-repeat";
      localStorage.setItem("lifes_bg_image", url);
    };
    reader.readAsDataURL(file);
  };

  const cardOpacityInput = document.getElementById("card-opacity");
  cardOpacityInput.oninput = () => {
    const val = cardOpacityInput.value;
    document.documentElement.style.setProperty("--card-color", `rgba(255,255,255,${val})`);
    localStorage.setItem("lifes_card_opacity", val);
  };

  const bg = localStorage.getItem("lifes_bg_color");
  const img = localStorage.getItem("lifes_bg_image");
  const op = localStorage.getItem("lifes_card_opacity");
  if (bg) {
    document.documentElement.style.setProperty("--bg-color", bg);
    bgColorInput.value = bg;
  }
  if (img) {
    document.body.style.backgroundImage = `url('${img}')`;
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundRepeat = "no-repeat";
  }
  if (op) {
    document.documentElement.style.setProperty("--card-color", `rgba(255,255,255,${op})`);
    cardOpacityInput.value = op;
  }

  window.changePassword = async () => {
    const pw = document.getElementById("new-password").value;
    if (pw.length < 6) {
      alert("6文字以上で入力してください。");
      return;
    }
    const { error } = await client.auth.updateUser({ password: pw });
    if (error) alert("変更失敗：" + error.message);
    else alert("パスワードを変更しました。");
  };

  window.resetStyles = () => {
    localStorage.removeItem("lifes_bg_color");
    localStorage.removeItem("lifes_bg_image");
    localStorage.removeItem("lifes_card_opacity");
    document.documentElement.style.setProperty("--bg-color", "#f0f4f8");
    document.documentElement.style.setProperty("--card-color", "rgba(255,255,255,0.9)");
    document.body.style.backgroundImage = "";
    document.getElementById("bg-color").value = "#f0f4f8";
    document.getElementById("card-opacity").value = "0.9";
  };

  window.logout = async () => {
    await client.auth.signOut();
    localStorage.clear();
    location.href = "index.html";
  };
})();
</script>
