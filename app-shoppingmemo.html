<!-- Ë≤∑„ÅÑÁâ©„É°„É¢„Ç¢„Éó„É™ v6Ôºö„Ç´„Éº„ÉâUI„Éª„Çπ„Éû„ÉõÂØæÂøú„ÉªSupabase‰øùÂ≠ò -->
<style>
  .memo-section {
    background-color: #e6f0ff;
    padding: 1rem;
    font-family: sans-serif;
  }

  .memo-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 1rem;
  }

  .memo-card {
    background: #fff;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .memo-input {
    border: none;
    font-size: 1rem;
    flex: 1;
    margin-right: 8px;
    background: transparent;
  }

  .memo-input:focus {
    outline: none;
  }

  .memo-delete {
    background: #f44336;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
  }

  .memo-add {
    display: block;
    margin: 1rem auto 0;
    background: #007bff;
    color: white;
    padding: 10px 16px;
    border: none;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
  }
</style>

<div class="memo-section">
  <h2>üõí Ë≤∑„ÅÑÁâ©„É°„É¢</h2>
  <div id="memoList" class="memo-list"></div>
  <button class="memo-add" onclick="addMemo()">Ôºã Ë°å„ÇíËøΩÂä†</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  
  let userId = null;

  (async () => {
    const { data: { user } } = await window.supabaseClient.auth.getUser();
    if (!user) return alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
    userId = user.id;
    loadMemos();
  });

  async function loadMemos() {
    const res = await supabase
      .from("shopping_memo")
      .select("*")
      .eq("user_id", userId)
      .order("sort_order", { ascending: true });

    const memos = res.data || [];
    const list = document.getElementById("memoList");
    list.innerHTML = "";

    if (memos.length === 0) {
      for (let i = 0; i < 5; i++) addMemo("", null, false);
    } else {
      memos.forEach((item, i) => {
        addMemo(item.content, item.id, false);
      });
    }

    Sortable.create(list, {
      animation: 150,
      onEnd: saveOrder
    });
  }

  function addMemo(content = "", id = null, focus = true) {
    const list = document.getElementById("memoList");
    const card = document.createElement("div");
    card.className = "memo-card";
    card.dataset.id = id;

    const input = document.createElement("input");
    input.className = "memo-input";
    input.placeholder = "ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
    input.value = content;

    input.onchange = async () => {
      const text = input.value.trim();
      if (!text) return;
      if (id) {
        await window.supabaseClient.from("shopping_memo").update({ content: text }).eq("id", id);
      } else {
        const { data, error } = await supabase
          .from("shopping_memo")
          .insert([{ user_id: userId, content: text, sort_order: list.children.length }])
          .select()
          .single();
        if (data?.id) {
          card.dataset.id = data.id;
        }
      }
    };

    const del = document.createElement("button");
    del.textContent = "√ó";
    del.className = "memo-delete";
    del.onclick = async () => {
      card.remove();
      if (card.dataset.id) {
        await window.supabaseClient.from("shopping_memo").delete().eq("id", card.dataset.id);
      }
      saveOrder();
    };

    card.appendChild(input);
    card.appendChild(del);
    list.appendChild(card);

    if (focus) input.focus();
  }

  async function saveOrder() {
    const cards = [...document.querySelectorAll(".memo-card")];
    for (let i = 0; i < cards.length; i++) {
      const id = cards[i].dataset.id;
      if (id) {
        await window.supabaseClient.from("shopping_memo").update({ sort_order: i }).eq("id", id);
      }
    }
  }
</script>
