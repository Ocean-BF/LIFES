
<!-- Ë≤∑„ÅÑÁâ©„É°„É¢„Ç¢„Éó„É™ÔºàÂÆåÂÖ®Áµ±ÂêàÁâàÔºâ -->
<style>
  #shopping-app {
    background-color: #f0f8ff;
    padding: 1rem;
    font-family: sans-serif;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 0.5rem;
    border: 1px solid #ccc;
    text-align: left;
  }
  button {
    padding: 0.25rem 0.5rem;
  }
</style>

<div id="shopping-app">
  <h2>üõí Ë≤∑„ÅÑÁâ©„É°„É¢</h2>
  <button onclick="addRow()">Ôºã Ë°å„ÇíËøΩÂä†</button>
  <table id="memoTable">
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabaseUrl = "https://udcrfwejohzmhfojnwha.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkY3Jmd2Vqb2h6bWhmb2pud2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5ODk1NzgsImV4cCI6MjA2MTU2NTU3OH0.dqy_L8iPlbUDoozkha4yjar4ADvinxGc0a6ygSuBLQI";
  const supabase = createClient(supabaseUrl, supabaseKey);

  let userId = null;

  document.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

    userId = user.id;
    loadMemos();
  });

  async function loadMemos() {
    const res = await supabase
      .from("shopping_memo")
      .select("*")
      .eq("user_id", userId)
      .order("sort_order", { ascending: true });

    const tableBody = document.querySelector("#memoTable tbody");
    tableBody.innerHTML = "";

    const memos = res.data || [];
    for (let i = 0; i < Math.max(5, memos.length); i++) {
      const row = document.createElement("tr");
      row.dataset.index = i;
      row.innerHTML = `
        <td contenteditable="true">${memos[i]?.content || ""}</td>
        <td><button onclick="deleteRow(this, '${memos[i]?.id || ""}')">√ó</button></td>
      `;
      tableBody.appendChild(row);
    }

    Sortable.create(tableBody, {
      animation: 150,
      onEnd: saveOrder
    });
  }

  async function addRow() {
    const tableBody = document.querySelector("#memoTable tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
      <td contenteditable="true"></td>
      <td><button onclick="deleteRow(this)">√ó</button></td>
    `;
    tableBody.appendChild(row);
  }

  async function deleteRow(btn, id = null) {
    const row = btn.closest("tr");
    row.remove();
    if (id) {
      await supabase.from("shopping_memo").delete().eq("id", id);
    }
  }

  async function saveOrder() {
    const rows = document.querySelectorAll("#memoTable tbody tr");
    await supabase.from("shopping_memo").delete().eq("user_id", userId);

    for (let i = 0; i < rows.length; i++) {
      const content = rows[i].querySelector("td").textContent.trim();
      if (content !== "") {
        await supabase.from("shopping_memo").insert({
          user_id: userId,
          content,
          sort_order: i
        });
      }
    }
  }
</script>
